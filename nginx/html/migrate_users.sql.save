cat > /home/huyenvn/iot-stack/nginx/html/migrate_users.sql <<'SQL'
-- Thêm cột mới (nếu chưa có)
ALTER TABLE users ADD COLUMN IF NOT EXISTS password_salt VARBINARY(16) NULL AFTER username;
ALTER TABLE users ADD COLUMN IF NOT EXISTS password_hash VARBINARY(32) NULL AFTER password_salt;

-- Cho phép cột password (legacy) NULL để tránh lỗi NOT NULL khi chèn user mới
ALTER TABLE users MODIFY COLUMN password VARCHAR(255) NULL DEFAULT NULL;

-- Tạo bảng sessions (nếu chưa có)
CREATE TABLE IF NOT EXISTS sessions (
  token CHAR(64) PRIMARY KEY,
  user_id INT NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  expires_at DATETIME NOT NULL,
  ip VARCHAR(64),
  user_agent VARCHAR(255),
  INDEX idx_user (user_id),
  INDEX idx_expires (expires_at)
) ENGINE=InnoDB;

-- Reset tài khoản admin
DELETE FROM users WHERE username='admin';

SET @pass = 'admin123';
SET @salt = UNHEX(REPLACE(UUID(),'-',''));  -- 16 bytes random

-- Chèn lại user admin; để password legacy = '' (hoặc NULL)
INSERT INTO users (username, password, password_salt, password_hash)
VALUES ('admin', '', @salt, UNHEX(SHA2(CONCAT(HEX(@salt), @pass), 256)));

-- Ràng buộc NOT NULL cho 2 cột mới sau khi đã có dữ liệu
ALTER TABLE users MODIFY password_salt VARBINARY(16) NOT NULL;
ALTER TABLE users MODIFY password_hash VARBINARY(32) NOT NULL;
SQL
